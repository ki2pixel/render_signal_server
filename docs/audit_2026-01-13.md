# Audit technique â€“ 13 janvier 2026

## 1. RÃ©sumÃ© exÃ©cutif
- **Ã‰tat globalÂ : C (risques notables)** â€“ Architecture orientÃ©e services et sÃ©curitÃ© HMAC pour les magic links restent solides, mais plusieurs failles de confidentialitÃ© (logs/payloads dâ€™e-mails) et de rÃ©silience (verrou poller, fallback R2) exigent des mesures rapides.  

### Mise Ã  jour 14 janvier 2026 â€” Statut Lot 3 (Performance & Validation)
- âœ… **Lot 3 complÃ©tÃ©** : protection anti-OOM parsing HTML (troncature stricte 1MB avec WARNING), test dâ€™intÃ©gration rÃ©silience R2 (`tests/test_r2_resilience.py`) garantissant lâ€™envoi du webhook mÃªme si Worker R2 Ã©choue.
- ğŸ“ **Impact** : plus de risque dâ€™OOM kill sur petits conteneurs (512MB) face Ã  e-mails HTML Ã©normes/malformÃ©s, flux webhook robuste mÃªme en cas de panne Worker R2 (conservation `raw_url`, absence `r2_url`).
- â–¶ï¸ **RÃ©sultat** : 3 passed (test R2 resilience), suite complÃ¨te 389 passed, 13 skipped, 0 failed (exÃ©cutÃ© dans `/mnt/venv_ext4/venv_render_signal_server`).

### Mise Ã  jour 14 janvier 2026 â€” Statut Lot 2 (RÃ©silience)
- âœ… **Lot 2 complÃ©tÃ©** : verrou distribuÃ© Redis avec fallback fcntl (`background/lock.py`), fallback R2 garanti (`email_processing/orchestrator.py`), watchdog IMAP timeout 30s (`email_processing/imap_client.py`), tests unitaires Redis lock crÃ©Ã©s (`tests/test_lock_redis.py`).
- ğŸ“ **Impact** : plus de risque de multi-polling sur Render multi-conteneurs, flux email jamais interrompu mÃªme si R2 indisponible, protection contre blocages IMAP zombies.
- â–¶ï¸ **RÃ©sultat** : 386 passed, 13 skipped, 0 failed (exÃ©cutÃ© dans `/mnt/venv_ext4/venv_render_signal_server`), couverture 70.12%.

### Mise Ã  jour 14 janvier 2026 â€” Statut Lot 1 (SÃ©curitÃ©)
- âœ… **Lot 1 complÃ©tÃ©** : anonymisation systÃ©matique des journaux (`mask_sensitive_data`), verrous + Ã©critures atomiques sur les services Runtime/WebhookConfig, allowlist stricte des domaines R2 cÃ´tÃ© backend.
- ğŸ“ **Impact** : plus aucune PII brute dans les logs/payloads, Ã©limination des corruptions concurrentes, blocage prÃ©ventif des fetchs distants non autorisÃ©s.
- â–¶ï¸ **Suite** : lancement du Lot 2 (RÃ©silience & Architecture) pour adresser le verrou distribuÃ© Redis, le fallback R2 garanti et le watchdog IMAP.

## 2. VulnÃ©rabilitÃ©s critiques
1. **Fuite potentielle de donnÃ©es sensibles**Â : Le poller journalise sujet et expÃ©diteur de chaque e-mail et transmet le corps complet (`bodyPreview`, `email_content`) au backend PHP, exposant des contenus RGPD si les logs ou `webhook_links.json` sont compromis.@email_processing/orchestrator.py#474-956  
2. **Lockfile inefficace en multi-conteneurs Render**Â : `background/lock.py` ne verrouille quâ€™au sein dâ€™un filesystem local ; lors dâ€™un dÃ©ploiement zero-downtime, deux pollers peuvent tourner simultanÃ©ment et traiter les mÃªmes messages.@background/lock.py#1-42  
3. **Offload R2 sans validation cÃ´tÃ© backend**Â : Le Worker Cloudflare valide `X-R2-FETCH-TOKEN`, mais le backend Render nâ€™applique pas dâ€™allowlist des domaines avant de dÃ©clencher le Worker et ne loggue pas les Ã©checs â†’ vecteur SSRF silencieux si lâ€™endpoint Worker fuit.@services/r2_transfer_service.py#131-218 @deployment/cloudflare-worker/worker.js#42-194  

## 3. Tableau dâ€™audit dÃ©taillÃ©

| Composant | Ã‰tat | ProblÃ¨me identifiÃ© | Recommandation |
| --- | --- | --- | --- |
| MagicLinkService | âš ï¸ | Verrou RLock uniquement en mÃ©moire ; si `fcntl` indisponible ou si plusieurs processus Ã©crivent sans lock OS, course possible. | Rendre lâ€™interprocess lock obligatoire (Ã©chouer si `fcntl` absent en prod) et ajouter rate limiting sur `/api/auth/magic-link`.@services/magic_link_service.py#91-345 @routes/api_auth.py#10-44 |
| R2TransferService + Worker | âš ï¸ | Validation des domaines uniquement cÃ´tÃ© Worker, logs silencieux cÃ´tÃ© backend, absence de fallback explicite Ã  `raw_url` si `r2_url` manquant.@services/r2_transfer_service.py#131-314 @email_processing/orchestrator.py#645-709 | Ajouter allowlist cÃ´tÃ© Python, signer les payloads, journaliser les Ã©checs et garantir que chaque `delivery_link` conserve lâ€™URL source. |
| WebhookConfigService | âš ï¸ | `validate_webhook_url` permet `""` et dÃ©pend dâ€™un external store pouvant contourner la normalisation `https://`.@services/webhook_config_service.py#96-385 | RÃ©appliquer `normalize_make_webhook_url`/validation lors de toute Ã©criture (store externe inclus) et refuser les schÃ©mas non HTTPS. |
| RuntimeFlagsService | âš ï¸ | Cache partagÃ© sans verrou et Ã©criture JSON non atomique â†’ race condition possible, corruption en cas de crash.@services/runtime_flags_service.py#124-262 | Ajouter `threading.RLock`, Ã©crire via fichier temporaire + `os.replace`, logguer lâ€™invalidation. |
| Polling IMAP & threading | âš ï¸ | Aucun mÃ©canisme de reconnexion si `mail.fetch` bloque ; une exception laisse la boucle tourner avec une connexion morte.@email_processing/imap_client.py#25-83 @background/polling_thread.py#51-134 | Ajouter timeouts, watchdog de reconnexion et circuit breaker qui recrÃ©e la connexion aprÃ¨s `run_poll_cycle` erronÃ©. |
| Logging & Privacy | âŒ | Sujets/expÃ©diteurs loggÃ©s en INFO ainsi que lâ€™Ã©tat des routes legacy, sans masquage PII.@email_processing/orchestrator.py#474-615 | DÃ©placer ces logs en DEBUG et hacher les identifiants (tokenizing). |
| Offload fallback | âš ï¸ | Si le Worker retourne 500/timeout, lâ€™entrÃ©e `delivery_links` peut rester sans `raw_url` (selon extraction) et aucun compteur dâ€™erreur nâ€™est exposÃ©.@email_processing/orchestrator.py#645-709 | Toujours conserver `raw_url`, exposer mÃ©triques dâ€™Ã©chec et forcer un fallback explicite. |
| Tests | âš ï¸ | Tests MagicLink couvrent seulement usage mÃ©moire, pas les scÃ©narios interprocess/external store critiques ; orchestrator non testÃ© sur gros HTML et sur Worker dÃ©faillant.@tests/test_services.py#315-412 @tests/test_r2_transfer_service.py#103-338 | Ajouter tests dâ€™intÃ©gration Flask (flux magic link complet) et scÃ©narios orchestrator + Worker 5xx pour garantir le fallback. |

## 4. Plan dâ€™action priorisÃ© (1 semaine)
1. **Redaction/masquage PII**Â : tronquer `email_content`, hacher sujet/expÃ©diteur, sÃ©curiser `webhook_logs.json`.  
2. **Lock poller partagÃ©**Â : basculer sur Redis/DB (`SETNX`) pour empÃªcher les doubles instances.  
3. **Durcissement R2**Â : allowlist cÃ´tÃ© backend, logs dâ€™Ã©checs, tests worker 5xx et fallback garanti.  
4. **Durcir services de config**Â : verrous + Ã©criture atomique pour RuntimeFlags/WebhookConfig + validation systÃ©matique HTTPS.  
5. **Resilience IMAP**Â : timeouts, reconnexions, mÃ©triques sur erreurs.  
6. **Couverture de tests critique**Â : tests dâ€™intÃ©gration sur magic links, orchestrator (gros HTML + Worker down).  

---

_Rapport Ã©tabli par Cascade â€“ 13/01/2026._
