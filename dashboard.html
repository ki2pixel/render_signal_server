<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAIAEAIAAAAAQAQAIZmZkAAADAAAAAwAAABwAAABwAAAAAQAAABwAAABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">
    <title>üìä Dashboard Webhooks - Contr√¥le</title>
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
    <!-- CSS Modular -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}?v=20260202-json-viewer">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules.css') }}">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <span class="emoji">üìä</span>Dashboard Webhooks
        </h1>
        <a href="/logout" class="logout-link">D√©connexion</a>
      </div>
      
      <!-- Bandeau Statut Global -->
      <div id="globalStatusBanner" class="global-status-banner">
        <div class="status-header">
          <div class="status-title">
            <span class="status-icon" id="globalStatusIcon">üü¢</span>
            <span class="status-text">Statut Global</span>
          </div>
          <div class="status-refresh">
            <button id="refreshStatusBtn" class="btn btn-small btn-secondary">üîÑ</button>
          </div>
        </div>
        <div class="status-content">
          <div class="status-item">
            <div class="status-label">Derni√®re ex√©cution</div>
            <div class="status-value" id="lastExecutionTime">‚Äî</div>
          </div>
          <div class="status-item">
            <div class="status-label">Incidents r√©cents</div>
            <div class="status-value" id="recentIncidents">‚Äî</div>
          </div>
          <div class="status-item">
            <div class="status-label">Erreurs critiques</div>
            <div class="status-value" id="criticalErrors">‚Äî</div>
          </div>
          <div class="status-item">
            <div class="status-label">Webhooks actifs</div>
            <div class="status-value" id="activeWebhooks">‚Äî</div>
          </div>
        </div>

      </div>
      
      <!-- Navigation principale -->
      <div class="nav-tabs" role="tablist">
        <button class="tab-btn active" data-target="#sec-overview" type="button">Vue d‚Äôensemble</button>
        <button class="tab-btn" data-target="#sec-webhooks" type="button">Webhooks</button>
        <button class="tab-btn" data-target="#sec-email" type="button">Email</button>
        <button class="tab-btn" data-target="#sec-preferences" type="button">Pr√©f√©rences</button>
        <button class="tab-btn" data-target="#sec-tools" type="button">Outils</button>
      </div>

      <!-- Section: Webhooks (panneaux pliables) -->
      <div id="sec-webhooks" class="section-panel config">
        <!-- Panneau 1: URLs & SSL -->
        <div class="collapsible-panel" data-panel="urls-ssl">
          <div class="panel-header">
            <div class="panel-title">
              <span>üîó</span>
              <span>URLs & SSL</span>
            </div>
            <div class="panel-toggle">
              <span class="panel-status" id="urls-ssl-status">Sauvegarde requise</span>
              <span class="toggle-icon">‚ñº</span>
            </div>
          </div>
          <div class="panel-content">
            <div class="form-group">
              <label for="webhookUrl">Webhook Personnalis√© (WEBHOOK_URL)</label>
              <input id="webhookUrl" type="text" placeholder="https://...">
            </div>
            <div style="margin-top: 15px;">
              <label class="toggle-switch" style="vertical-align: middle;">
                <input type="checkbox" id="sslVerifyToggle">
                <span class="toggle-slider"></span>
              </label>
              <span style="margin-left: 10px; vertical-align: middle;">V√©rification SSL (WEBHOOK_SSL_VERIFY)</span>
            </div>
            <div style="margin-top: 12px;">
              <label class="toggle-switch" style="vertical-align: middle;">
                <input type="checkbox" id="webhookSendingToggle">
                <span class="toggle-slider"></span>
              </label>
              <span style="margin-left: 10px; vertical-align: middle;">Activer l'envoi des webhooks (global)</span>
            </div>
            <div class="panel-actions">
              <button class="panel-save-btn" data-panel="urls-ssl">üíæ Enregistrer</button>
              <span class="panel-indicator" id="urls-ssl-indicator">Derni√®re sauvegarde: ‚Äî</span>
            </div>
            <div id="urls-ssl-msg" class="status-msg"></div>
          </div>
        </div>

        <!-- Panneau 2: Absence Globale -->
        <div class="collapsible-panel" data-panel="absence">
          <div class="panel-header">
            <div class="panel-title">
              <span>üö´</span>
              <span>Absence Globale</span>
            </div>
            <div class="panel-toggle">
              <span class="panel-status" id="absence-status">Sauvegarde requise</span>
              <span class="toggle-icon">‚ñº</span>
            </div>
          </div>
          <div class="panel-content">
            <div style="margin-bottom: 12px;">
              <label class="toggle-switch" style="vertical-align: middle;">
                <input type="checkbox" id="absencePauseToggle">
                <span class="toggle-slider"></span>
              </label>
              <span style="margin-left: 10px; vertical-align: middle; font-weight: 600;">Activer l'absence globale (stop emails)</span>
            </div>
            <div class="small-text" style="margin-bottom: 10px;">
              Lorsque activ√©, <strong>aucun email</strong> ne sera envoy√© (ni DESABO ni M√©dia Solution, urgent ou non) pour les jours s√©lectionn√©s ci-dessous.
            </div>
            <div class="form-group">
              <label>Jours d'absence (aucun email envoy√©)</label>
              <div id="absencePauseDaysGroup" class="inline-group" style="flex-wrap: wrap; gap: 12px; margin-top: 6px;">
                <label><input type="checkbox" name="absencePauseDay" value="monday"> Lundi</label>
                <label><input type="checkbox" name="absencePauseDay" value="tuesday"> Mardi</label>
                <label><input type="checkbox" name="absencePauseDay" value="wednesday"> Mercredi</label>
                <label><input type="checkbox" name="absencePauseDay" value="thursday"> Jeudi</label>
                <label><input type="checkbox" name="absencePauseDay" value="friday"> Vendredi</label>
                <label><input type="checkbox" name="absencePauseDay" value="saturday"> Samedi</label>
                <label><input type="checkbox" name="absencePauseDay" value="sunday"> Dimanche</label>
              </div>
              <div class="small-text">S√©lectionnez au moins un jour si vous activez l'absence.</div>
            </div>
            <div class="panel-actions">
              <button class="panel-save-btn" data-panel="absence">üíæ Enregistrer</button>
              <span class="panel-indicator" id="absence-indicator">Derni√®re sauvegarde: ‚Äî</span>
            </div>
            <div id="absence-msg" class="status-msg"></div>
          </div>
        </div>

        <!-- Panneau 3: Fen√™tre Horaire -->
        <div class="collapsible-panel" data-panel="time-window">
          <div class="panel-header">
            <div class="panel-title">
              <span>üïê</span>
              <span>Fen√™tre Horaire</span>
            </div>
            <div class="panel-toggle">
              <span class="panel-status" id="time-window-status">Sauvegarde requise</span>
              <span class="toggle-icon">‚ñº</span>
            </div>
          </div>
          <div class="panel-content">
            <div style="margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: var(--cork-text-primary);">Fen√™tre Horaire Globale</h4>
              <div class="form-group">
                <label for="webhooksTimeStart">Heure de d√©but</label>
                <select id="webhooksTimeStart" style="width: 100%; max-width: 120px;">
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="webhooksTimeEnd">Heure de fin</label>
                <select id="webhooksTimeEnd" style="width: 100%; max-width: 120px;">
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
              <div id="timeWindowMsg" class="status-msg"></div>
              <div id="timeWindowDisplay" class="small-text"></div>
              <div class="small-text">Laissez les deux champs vides pour d√©sactiver la contrainte horaire.</div>
              <div style="margin-top: 12px;">
                <button id="saveTimeWindowBtn" class="btn btn-primary btn-small">üíæ Enregistrer Fen√™tre Globale</button>
              </div>
            </div>
            
            <div style="padding: 12px; background: rgba(67, 97, 238, 0.1); border-radius: 6px; border-left: 3px solid var(--cork-primary-accent);">
              <h4 style="margin: 0 0 10px 0; color: var(--cork-text-primary);">Fen√™tre Horaire Webhooks</h4>
              <div class="form-group" style="margin-bottom: 10px;">
                <label for="globalWebhookTimeStart">Heure de d√©but</label>
                <select id="globalWebhookTimeStart" style="width: 100%; max-width: 100px;">
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 10px;">
                <label for="globalWebhookTimeEnd">Heure de fin</label>
                <select id="globalWebhookTimeEnd" style="width: 100%; max-width: 100px;">
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
              <div id="globalWebhookTimeMsg" class="status-msg" style="margin-top: 8px;"></div>
              <div class="small-text">D√©finissez quand les webhooks peuvent √™tre envoy√©s (laissez vide pour d√©sactiver).</div>
              <div style="margin-top: 12px;">
                <button id="saveGlobalWebhookTimeBtn" class="btn btn-primary btn-small">üíæ Enregistrer Fen√™tre Webhook</button>
              </div>
            </div>
            
            <div class="panel-actions">
              <span class="panel-indicator" id="time-window-indicator">Derni√®re sauvegarde: ‚Äî</span>
            </div>
          </div>
        </div>
      <!-- Panneau 4: Routage Dynamique -->
      <div class="collapsible-panel" data-panel="routing-rules">
        <div class="panel-header">
          <div class="panel-title">
            <span>üß≠</span>
            <span>Routage Dynamique</span>
            <button id="routing-rules-lock-btn" class="lock-btn" type="button" title="Verrouiller/D√©verrouiller l'√©dition des r√®gles">
              <span class="lock-icon" id="routing-rules-lock-icon">üîí</span>
            </button>
          </div>
          <div class="panel-toggle">
            <span class="panel-status" id="routing-rules-status">Sauvegarde requise</span>
            <span class="toggle-icon">‚ñº</span>
          </div>
        </div>
        <div class="panel-content">
          <div class="small-text" style="margin-bottom: 10px;">
            D√©finissez des r√®gles conditionnelles pour router les emails vers des webhooks d√©di√©s.
            Les r√®gles sont √©valu√©es dans l'ordre affich√©.
          </div>
          <div class="inline-group" style="margin-bottom: 12px;">
            <button id="addRoutingRuleBtn" type="button" class="btn btn-primary btn-small">‚ûï Ajouter une r√®gle</button>
            <button id="reloadRoutingRulesBtn" type="button" class="btn btn-secondary btn-small">üîÑ Recharger</button>
          </div>
          <div id="routingRulesList" class="routing-rules-list"></div>
          <div class="panel-actions">
            <span class="panel-indicator" id="routing-rules-indicator">Derni√®re sauvegarde: ‚Äî</span>
          </div>
          <div id="routing-rules-msg" class="status-msg"></div>
          <div id="routingRulesRedisInspectMsg" class="status-msg" style="margin-top: 12px;"></div>
          <pre id="routingRulesRedisInspectLog" class="code-block small-text" style="display:none;margin-top:12px;"></pre>
          <div id="routingRulesRedisInspectViewer" class="json-viewer-container" style="display:none;"></div>
        </div>
      </div>
      </div>

      <!-- Section: Pr√©f√©rences Email (exp√©diteurs, d√©dup) -->
      <div id="sec-email" class="section-panel">
        <div class="card">
          <div class="card-title">üß© Pr√©f√©rences Email (exp√©diteurs, d√©dup)</div>
          <div class="inline-group" style="margin: 8px 0 12px 0;">
            <label class="toggle-switch">
              <input type="checkbox" id="pollingToggle">
              <span class="toggle-slider"></span>
            </label>
            <span id="pollingStatusText" style="margin-left: 10px;">‚Äî</span>
          </div>
          <div id="pollingMsg" class="status-msg" style="margin-top: 6px;"></div>
          <div class="form-group">
            <label>SENDER_OF_INTEREST_FOR_POLLING</label>
            <div id="senderOfInterestContainer" class="stack" style="gap:8px;"></div>
            <button id="addSenderBtn" type="button" class="btn btn-secondary" style="margin-top:8px;">‚ûï Ajouter Email</button>
            <div class="small-text">Ajouter / modifier / supprimer des emails individuellement. Ils seront valid√©s et normalis√©s (minuscules).</div>
          </div>
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <div class="form-group">
              <label for="pollingStartHour">POLLING_ACTIVE_START_HOUR (0-23)</label>
              <select id="pollingStartHour" style="width: 100%; max-width: 100px;">
                <option value="">S√©lectionner...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="pollingEndHour">POLLING_ACTIVE_END_HOUR (0-23)</label>
              <select id="pollingEndHour" style="width: 100%; max-width: 100px;">
                <option value="">S√©lectionner...</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="margin-top: 10px;">
            <label>Jours actifs (POLLING_ACTIVE_DAYS)</label>
            <div id="pollingActiveDaysGroup" class="inline-group" style="flex-wrap: wrap; gap: 12px; margin-top: 6px;">
              <label><input type="checkbox" name="pollingDay" value="0"> Lun</label>
              <label><input type="checkbox" name="pollingDay" value="1"> Mar</label>
              <label><input type="checkbox" name="pollingDay" value="2"> Mer</label>
              <label><input type="checkbox" name="pollingDay" value="3"> Jeu</label>
              <label><input type="checkbox" name="pollingDay" value="4"> Ven</label>
              <label><input type="checkbox" name="pollingDay" value="5"> Sam</label>
              <label><input type="checkbox" name="pollingDay" value="6"> Dim</label>
            </div>
            <div class="small-text">0=Lundi ... 6=Dimanche. S√©lectionnez au moins un jour.</div>
          </div>
          <div class="inline-group" style="margin: 8px 0 12px 0;">
            <label class="toggle-switch">
              <input type="checkbox" id="enableSubjectGroupDedup">
              <span class="toggle-slider"></span>
            </label>
            <span style="margin-left: 10px;">ENABLE_SUBJECT_GROUP_DEDUP</span>
          </div>
          <button id="saveEmailPrefsBtn" class="btn btn-primary" style="margin-top: 15px;">üíæ Enregistrer les pr√©f√©rences</button>
          <div id="emailPrefsSaveStatus" class="status-msg" style="margin-top: 10px;"></div>
          <!-- Fallback status container (legacy ID used by JS as a fallback) -->
          <div id="pollingCfgMsg" class="status-msg" style="margin-top: 6px;"></div>
        </div>
        
      </div>

      <!-- Section: Pr√©f√©rences (filtres + fiabilit√©) -->
      <div id="sec-preferences" class="section-panel">
        <div class="card">
          <div class="card-title">üîç Filtres Email Avanc√©s</div>
          <div class="form-group">
            <label for="excludeKeywordsRecadrage">Mots-cl√©s √† exclure (Recadrage) ‚Äî un par ligne</label>
            <textarea id="excludeKeywordsRecadrage" rows="4" style="width:100%; padding:10px; border-radius:4px; border:1px solid var(--cork-border-color); background: rgba(0,0,0,0.2); color: var(--cork-text-primary);"></textarea>
            <div class="small-text">Ces mots-cl√©s emp√™cheront l'envoi du webhook `RECADRAGE_MAKE_WEBHOOK_URL` si trouv√©s dans le sujet ou le corps.</div>
          </div>
          <div class="form-group">
            <label for="excludeKeywordsAutorepondeur">Mots-cl√©s √† exclure (Autor√©pondeur) ‚Äî un par ligne</label>
            <textarea id="excludeKeywordsAutorepondeur" rows="4" style="width:100%; padding:10px; border-radius:4px; border:1px solid var(--cork-border-color); background: rgba(0,0,0,0.2); color: var(--cork-text-primary);"></textarea>
            <div class="small-text">Ces mots-cl√©s emp√™cheront l'envoi du webhook `AUTOREPONDEUR_MAKE_WEBHOOK_URL` si trouv√©s dans le sujet ou le corps.</div>
          </div>
          <div class="form-group">
            <label for="excludeKeywords">Mots-cl√©s √† exclure (global, compatibilit√©) ‚Äî un par ligne</label>
            <textarea id="excludeKeywords" rows="3" style="width:100%; padding:10px; border-radius:4px; border:1px solid var(--cork-border-color); background: rgba(0,0,0,0.2); color: var(--cork-text-primary);"></textarea>
            <div class="small-text">Liste globale (h√©ritage). S'applique avant toute logique et avant les listes sp√©cifiques.</div>
          </div>
          <div class="form-group">
            <label for="attachmentDetectionToggle">D√©tection de pi√®ces jointes requise</label>
            <label class="toggle-switch" style="vertical-align: middle; margin-left:10px;">
              <input type="checkbox" id="attachmentDetectionToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="form-group">
            <label for="maxEmailSizeMB">Taille maximale des emails √† traiter (Mo)</label>
            <input id="maxEmailSizeMB" type="number" min="1" max="100" placeholder="ex: 25">
          </div>
          <div class="form-group">
            <label for="senderPriority">Priorit√© des exp√©diteurs (JSON simple)</label>
            <textarea id="senderPriority" rows="3" placeholder='{"vip@example.com":"high","team@example.com":"medium"}' style="width:100%; padding:10px; border-radius:4px; border:1px solid var(--cork-border-color); background: rgba(0,0,0,0.2); color: var(--cork-text-primary);"></textarea>
            <div class="small-text">Format: { "email": "high|medium|low", ... } ‚Äî Valid√© c√¥t√© client uniquement pour l'instant.</div>
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-title">‚ö° Param√®tres de Fiabilit√©</div>
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group">
              <label for="retryCount">Nombre de tentatives (retries)</label>
              <input id="retryCount" type="number" min="0" max="10" placeholder="ex: 3">
            </div>
            <div class="form-group">
              <label for="retryDelaySec">D√©lai entre retries (secondes)</label>
              <input id="retryDelaySec" type="number" min="0" max="600" placeholder="ex: 10">
            </div>
            <div class="form-group">
              <label for="webhookTimeoutSec">Timeout Webhook (secondes)</label>
              <input id="webhookTimeoutSec" type="number" min="1" max="120" placeholder="ex: 30">
            </div>
            <div class="form-group">
              <label for="rateLimitPerHour">Limite d'envoi (webhooks/heure)</label>
              <input id="rateLimitPerHour" type="number" min="1" max="10000" placeholder="ex: 300">
            </div>
          </div>
          <div style="margin-top: 8px;">
            <label class="toggle-switch" style="vertical-align: middle;">
              <input type="checkbox" id="notifyOnFailureToggle">
              <span class="toggle-slider"></span>
            </label>
            <span style="margin-left: 10px; vertical-align: middle;">Notifications d'√©chec par email (UI-only)</span>
          </div>
          <div style="margin-top: 12px;">
            <button id="processingPrefsSaveBtn" class="btn btn-primary">üíæ Enregistrer Pr√©f√©rences de Traitement</button>
            <div id="processingPrefsMsg" class="status-msg"></div>
          </div>
        </div>
      </div>

      <!-- Section: Vue d'ensemble (logs) -->
      <div id="sec-overview" class="section-panel monitoring active">
        <div class="logs-container">
          <div class="card-title">üìú Historique des Webhooks (7 derniers jours)</div>
          <div style="margin-bottom: 15px;">
            <button id="refreshLogsBtn" class="btn btn-primary">üîÑ Actualiser</button>
          </div>
          <div id="webhookLogs">
            <div class="log-empty">Chargement des logs...</div>
          </div>
        </div>
      </div>

      <!-- Section: Outils (config mgmt + outils de test) -->
      <div id="sec-tools" class="section-panel">
        <div class="card">
          <div class="card-title">üíæ Gestion des Configurations</div>
          <div class="inline-group" style="margin-bottom: 10px;">
            <button id="exportConfigBtn" class="btn btn-primary">‚¨áÔ∏è Exporter</button>
            <input id="importConfigFile" type="file" accept="application/json" style="display:none;"/>
            <button id="importConfigBtn" class="btn btn-primary">‚¨ÜÔ∏è Importer</button>
          </div>
          <div id="configMgmtMsg" class="status-msg"></div>
          <div class="small-text">L'export inclut la configuration serveur (webhooks, polling, fen√™tre horaire) + pr√©f√©rences UI locales (filtres, fiabilit√©). L'import applique automatiquement ce qui est support√© par les endpoints existants.</div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-title">üöÄ D√©ploiement de l'application</div>
          <div class="form-group">
            <p class="small-text">Certaines modifications (ex: param√®tres applicatifs, configuration reverse proxy) n√©cessitent un d√©ploiement pour √™tre pleinement appliqu√©es.</p>
          </div>
          <div class="inline-group" style="margin-bottom: 10px;">
            <button id="restartServerBtn" class="btn btn-success">üöÄ D√©ployer l'application</button>
          </div>
          <div id="restartMsg" class="status-msg"></div>
          <div class="small-text">Cette action d√©clenche un d√©ploiement c√¥t√© serveur (commande configur√©e). L'application peut √™tre momentan√©ment indisponible.</div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-title">üóÇÔ∏è Migration configs ‚Üí Redis</div>
          <p>Rejouez le script <code>migrate_configs_to_redis.py</code> directement sur le serveur Render avec toutes les variables d'environnement de production.</p>
          <div class="inline-group" style="margin-bottom: 10px;">
            <button id="migrateConfigsBtn" class="btn btn-warning">üì¶ Migrer les configurations</button>
          </div>
          <div id="migrateConfigsMsg" class="status-msg"></div>
          <pre id="migrateConfigsLog" class="code-block small-text" style="display:none;margin-top:12px;"></pre>
          <hr style="margin: 18px 0; border-color: rgba(255,255,255,0.1);">
          <p style="margin-bottom:10px;">V√©rifiez l'√©tat des donn√©es persist√©es dans Redis (structures JSON, attributs requis, dates de mise √† jour).</p>
          <div class="inline-group" style="margin-bottom: 10px;">
            <button id="verifyConfigStoreBtn" class="btn btn-info">üîç V√©rifier les donn√©es en Redis</button>
          </div>
          <label for="verifyConfigStoreRawToggle" class="small-text" style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
            <input type="checkbox" id="verifyConfigStoreRawToggle">
            <span>Inclure le JSON complet dans le log pour faciliter le debug.</span>
          </label>
          <div id="verifyConfigStoreMsg" class="status-msg"></div>
          <pre id="verifyConfigStoreLog" class="code-block small-text" style="display:none;margin-top:12px;"></pre>
          <div id="verifyConfigStoreViewer" class="json-viewer-container" style="display:none;"></div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-title">üîê Acc√®s Magic Link</div>
          <p>G√©n√©rez un lien pr√©-authentifi√© √† usage unique pour ouvrir rapidement le dashboard sans retaper vos identifiants. Le lien est automatiquement copi√©.</p>
          <div class="inline-group" style="margin-bottom: 12px;">
            <label class="toggle-switch">
              <input type="checkbox" id="magicLinkUnlimitedToggle">
              <span class="toggle-slider"></span>
            </label>
            <span style="margin-left: 10px;">
              Mode illimit√© (d√©sactiv√© = lien one-shot avec expiration)
            </span>
          </div>
          <button id="generateMagicLinkBtn" class="btn btn-primary">‚ú® G√©n√©rer un magic link</button>
          <div id="magicLinkOutput" class="status-msg" style="margin-top: 12px;"></div>
          <div class="small-text">
            Important : partagez ce lien uniquement avec des personnes autoris√©es.
            En mode one-shot, il expire apr√®s quelques minutes et s'invalide d√®s qu'il est utilis√©.
            En mode illimit√©, aucun d√©lai mais vous devez r√©voquer manuellement en cas de fuite.
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-title">üß™ Outils de Test</div>
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group">
              <label for="testWebhookUrl">Valider une URL de webhook</label>
              <input id="testWebhookUrl" type="text" placeholder="https://hook.eu2.make.com/<token> ou <token>@hook.eu2.make.com">
              <button id="validateWebhookUrlBtn" class="btn btn-primary" style="margin-top: 8px;">Valider</button>
              <div id="webhookUrlValidationMsg" class="status-msg"></div>
            </div>
            <div class="form-group">
              <label>Pr√©visualiser un payload</label>
              <input id="previewSubject" type="text" placeholder="Sujet d'email (ex: M√©dia Solution - Lot 123)">
              <input id="previewSender" type="email" placeholder="Exp√©diteur (ex: media@solution.fr)" style="margin-top: 6px;">
              <textarea id="previewBody" rows="4" placeholder="Corps de l'email (coller du texte)" style="margin-top: 6px; width:100%; padding:10px; border-radius:4px; border:1px solid var(--cork-border-color); background: rgba(0,0,0,0.2); color: var(--cork-text-primary);"></textarea>
              <button id="buildPayloadPreviewBtn" class="btn btn-primary" style="margin-top: 8px;">G√©n√©rer</button>
              <pre id="payloadPreview" style="margin-top:8px; background: rgba(0,0,0,0.2); border:1px solid var(--cork-border-color); padding:10px; border-radius:4px; max-height:200px; overflow:auto; color: var(--cork-text-primary);"></pre>
            </div>
          </div>
          <div class="small-text">Le test de connectivit√© IMAP en temps r√©el n√©cessitera un endpoint serveur d√©di√© (non inclus pour l'instant).</div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-title">üîó Ouvrir une page de t√©l√©chargement</div>
          <div class="form-group">
            <label for="downloadPageUrl">URL de la page de t√©l√©chargement (Dropbox / FromSmash / SwissTransfer)</label>
            <input id="downloadPageUrl" type="url" placeholder="https://www.swisstransfer.com/d/<uuid> ou https://fromsmash.com/<id>">
            <button id="openDownloadPageBtn" class="btn btn-primary" style="margin-top: 8px;">Ouvrir la page</button>
            <div id="openDownloadMsg" class="status-msg"></div>
            <div class="small-text">Note: L'application n'essaie plus d'extraire des liens de t√©l√©chargement directs. Utilisez ce bouton pour ouvrir la page d'origine et t√©l√©charger manuellement.</div>
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-title"> Flags Runtime (Debug)</div>
          <div class="form-group">
            <label>Bypass d√©duplication par ID d‚Äôemail (debug)</label>
            <label class="toggle-switch" style="vertical-align: middle; margin-left:10px;">
              <input type="checkbox" id="disableEmailIdDedupToggle">
              <span class="toggle-slider"></span>
            </label>
            <div class="small-text">Quand activ√©, ignore la d√©duplication par ID d'email. √Ä utiliser uniquement pour des tests.
            </div>
          </div>
          <div class="form-group" style="margin-top: 10px;">
            <label>Autoriser envoi CUSTOM sans liens de livraison</label>
            <label class="toggle-switch" style="vertical-align: middle; margin-left:10px;">
              <input type="checkbox" id="allowCustomWithoutLinksToggle">
              <span class="toggle-slider"></span>
            </label>
            <div class="small-text">Si d√©sactiv√© (recommand√©), l'envoi CUSTOM est ignor√© lorsqu‚Äôaucun lien (Dropbox/FromSmash/SwissTransfer) n‚Äôest d√©tect√©, pour √©viter les 422.</div>
          </div>
          <div style="margin-top: 12px;">
            <button id="runtimeFlagsSaveBtn" class="btn btn-primary"> Enregistrer Flags Runtime</button>
            <div id="runtimeFlagsMsg" class="status-msg"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Chargement des modules JavaScript -->
    <script type="module" src="{{ url_for('static', filename='utils/MessageHelper.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='services/ApiService.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='services/WebhookService.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='services/LogService.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='components/TabManager.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='dashboard.js') }}?v=20260202-json-viewer"></script>
  </body>
</html>