<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test Validation - render_signal_server</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0f1115; color: #e8eaed; }
    header { padding: 14px 18px; border-bottom: 1px solid #2a2f3a; background: #121520; }
    h1 { font-size: 18px; margin: 0; }
    main { padding: 18px; display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card { border: 1px solid #2a2f3a; border-radius: 8px; padding: 14px; background: #161a22; }
    .card h2 { font-size: 16px; margin: 0 0 10px 0; }
    .row { display: flex; gap: 8px; align-items: center; margin: 6px 0; flex-wrap: wrap; }
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 8px; background: #10131a; border: 1px solid #2a2f3a; color: #e8eaed; border-radius: 6px; }
    textarea { min-height: 90px; }
    button { background: #2563eb; color: white; border: 0; padding: 8px 10px; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #334155; }
    pre.out { background: #0e1016; border: 1px solid #2a2f3a; padding: 8px; border-radius: 6px; max-height: 240px; overflow: auto; white-space: pre-wrap; }
    .small { color: #a9b1bd; font-size: 12px; }
    .ok { color: #22c55e; }
    .err { color: #ef4444; }
    label { font-size: 13px; color: #cbd5e1; }
  </style>
</head>
<body>
  <header>
    <h1>üß™ Test Validation (Prefs, Logs, Export/Import, Metrics)</h1>
    <div class="row" style="margin-top:8px;">
      <label for="apiBase">API Base URL</label>
      <input id="apiBase" type="text" placeholder="ex: http://localhost:10000" value="" />
      <button id="btnSetBase" class="secondary">Utiliser</button>
      <span class="small">Laissez vide pour utiliser le m√™me origin (si proxifi√©).</span>
    </div>
    <div class="row">
      <label for="apiKey">X-API-Key (optionnel, requis pour /api/test/*)</label>
      <input id="apiKey" type="text" placeholder="cl√© de test (TEST_API_KEY)" value="" />
      <span class="small">Assurez-vous que votre backend a CORS activ√© pour votre domaine via CORS_ALLOWED_ORIGINS.</span>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>1) Pr√©f√©rences de traitement</h2>
      <div class="row"><button id="btnLoadPrefs">Charger (GET /api/test/get_processing_prefs)</button></div>
      <div class="row"><label>exclude_keywords (un par ligne)</label><textarea id="prefExclude"></textarea></div>
      <div class="row"><label>require_attachments</label><input id="prefRequireAttach" type="checkbox" /></div>
      <div class="row"><label>max_email_size_mb</label><input id="prefMaxMb" type="number" min="1" /></div>
      <div class="row"><label>sender_priority (JSON)</label><textarea id="prefSenderPriority" placeholder='{"vip@example.com":"high"}'></textarea></div>
      <div class="row">
        <div style="flex:1"><label>retry_count</label><input id="prefRetryCount" type="number" min="0" max="10" /></div>
        <div style="flex:1"><label>retry_delay_sec</label><input id="prefRetryDelay" type="number" min="0" max="600" /></div>
      </div>
      <div class="row">
        <div style="flex:1"><label>webhook_timeout_sec</label><input id="prefTimeout" type="number" min="1" max="300" /></div>
        <div style="flex:1"><label>rate_limit_per_hour</label><input id="prefRateLimit" type="number" min="0" max="100000" /></div>
      </div>
      <div class="row"><label>notify_on_failure</label><input id="prefNotifyFail" type="checkbox" /></div>
      <div class="row"><button id="btnSavePrefs">Sauvegarder (POST /api/test/update_processing_prefs)</button></div>
      <pre id="outPrefs" class="out"></pre>
    </section>

    <section class="card">
      <h2>2) Logs Webhooks</h2>
      <div class="row">
        <button id="btnLogs1">Charger logs 24h (GET /api/test/webhook_logs?days=1)</button>
        <button id="btnLogs7" class="secondary">Charger logs 7j (GET /api/test/webhook_logs?days=7)</button>
      </div>
      <pre id="outLogs" class="out"></pre>
      <div class="small">Affiche le nombre d'entr√©es et un extrait. Persistance: Redis si configur√©, sinon fichier.</div>
    </section>

    <section class="card">
      <h2>3) Export / Import Config</h2>
      <div class="row">
        <button id="btnExport">Exporter (multi-GET)</button>
        <button id="btnImport" class="secondary">Importer (multi-POST)</button>
      </div>
      <textarea id="ioConfig" placeholder="Export JSON ici..."></textarea>
      <pre id="outConfig" class="out"></pre>
    </section>

    <section class="card">
      <h2>4) M√©triques (client)</h2>
      <div class="row"><button id="btnMetrics">Calculer depuis /api/webhook_logs?days=1</button></div>
      <pre id="outMetrics" class="out"></pre>
    </section>

    <section class="card">
      <h2>5) Outils</h2>
      <div class="row"><label>URL Make.com ou alias token@hook.euX.make.com</label><input id="inWebhookUrl" type="text" placeholder="https://hook.eu2.make.com/<token> ou token@hook.eu2.make.com" /></div>
      <div class="row"><button id="btnValidate">Valider URL</button><span id="lblValidate" class="small"></span></div>
      <div class="row"><label>Sujet</label><input id="inSubject" type="text" placeholder="Sujet" /></div>
      <div class="row"><label>Exp√©diteur</label><input id="inSender" type="email" placeholder="email@domain.com" /></div>
      <div class="row"><label>Corps</label><textarea id="inBody" placeholder="Texte..."></textarea></div>
      <div class="row"><button id="btnPreview">G√©n√©rer Payload Preview</button></div>
      <pre id="outPreview" class="out"></pre>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    let base = '';
    const api = (p) => (base ? base.replace(/\/$/, '') : '') + p;
    const headers = () => {
      const h = { 'Content-Type': 'application/json' };
      const k = $('apiKey').value.trim();
      if (k) h['X-API-Key'] = k;
      return h;
    };

    function setOut(id, obj) {
      $(id).textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    $('btnSetBase').onclick = () => { base = $('apiBase').value.trim(); };

    // --- Prefs ---
    $('btnLoadPrefs').onclick = async () => {
      try {
        const r = await fetch(api('/api/test/get_processing_prefs'), { headers: headers() });
        const d = await r.json();
        setOut('outPrefs', d);
        if (d.success) fillPrefs(d.prefs || {});
      } catch (e) { setOut('outPrefs', { error: String(e) }); }
    };

    function fillPrefs(p) {
      $('prefExclude').value = (p.exclude_keywords || []).join('\n');
      $('prefRequireAttach').checked = !!p.require_attachments;
      $('prefMaxMb').value = p.max_email_size_mb ?? '';
      $('prefSenderPriority').value = JSON.stringify(p.sender_priority || {}, null, 2);
      $('prefRetryCount').value = p.retry_count ?? '';
      $('prefRetryDelay').value = p.retry_delay_sec ?? '';
      $('prefTimeout').value = p.webhook_timeout_sec ?? '';
      $('prefRateLimit').value = p.rate_limit_per_hour ?? '';
      $('prefNotifyFail').checked = !!p.notify_on_failure;
    }

    $('btnSavePrefs').onclick = async () => {
      try {
        let senderPriority = {};
        const sp = $('prefSenderPriority').value.trim();
        if (sp) { try { senderPriority = JSON.parse(sp); } catch { senderPriority = {}; } }
        const payload = {
          exclude_keywords: $('prefExclude').value.split(/\n+/).map(s=>s.trim()).filter(Boolean),
          require_attachments: $('prefRequireAttach').checked,
          max_email_size_mb: $('prefMaxMb').value === '' ? null : parseInt($('prefMaxMb').value, 10),
          sender_priority: senderPriority,
          retry_count: $('prefRetryCount').value === '' ? 0 : parseInt($('prefRetryCount').value, 10),
          retry_delay_sec: $('prefRetryDelay').value === '' ? 0 : parseInt($('prefRetryDelay').value, 10),
          webhook_timeout_sec: $('prefTimeout').value === '' ? 30 : parseInt($('prefTimeout').value, 10),
          rate_limit_per_hour: $('prefRateLimit').value === '' ? 0 : parseInt($('prefRateLimit').value, 10),
          notify_on_failure: $('prefNotifyFail').checked,
        };
        const r = await fetch(api('/api/test/update_processing_prefs'), { method:'POST', headers: headers(), body: JSON.stringify(payload)});
        const d = await r.json();
        setOut('outPrefs', d);
      } catch (e) { setOut('outPrefs', { error: String(e) }); }
    };

    // --- Logs ---
    $('btnLogs1').onclick = () => loadLogs(1);
    $('btnLogs7').onclick = () => loadLogs(7);
    async function loadLogs(days) {
      try {
        const r = await fetch(api('/api/test/webhook_logs?days=' + days), { headers: headers() });
        const d = await r.json();
        const summary = { count: d.count, days_filter: d.days_filter, first: d.logs?.[0] };
        setOut('outLogs', summary);
      } catch (e) { setOut('outLogs', { error: String(e) }); }
    }

    // --- Export / Import ---
    $('btnExport').onclick = async () => {
      try {
        const [w, p, t, x] = await Promise.all([
          fetch(api('/api/test/get_webhook_config'), { headers: headers() }).then(r=>r.json()),
          fetch(api('/api/test/get_polling_config'), { headers: headers() }).then(r=>r.json()),
          fetch(api('/api/test/get_webhook_time_window'), { headers: headers() }).then(r=>r.json()),
          fetch(api('/api/test/get_processing_prefs'), { headers: headers() }).then(r=>r.json()),
        ]);
        const out = { exported_at: new Date().toISOString(), webhook_config: w, polling_config: p, time_window: t, processing_prefs: x };
        $('ioConfig').value = JSON.stringify(out, null, 2);
        setOut('outConfig', { success: true, note: 'Export OK' });
      } catch (e) { setOut('outConfig', { error: String(e) }); }
    };

    $('btnImport').onclick = async () => {
      try {
        const obj = JSON.parse($('ioConfig').value || '{}');
        const calls = [];
        if (obj.webhook_config?.config) calls.push(fetch(api('/api/test/update_webhook_config'), { method:'POST', headers: headers(), body: JSON.stringify(obj.webhook_config.config)}).then(r=>r.json()));
        if (obj.polling_config?.config) calls.push(fetch(api('/api/test/update_webhook_config'), { method:'POST', headers: headers(), body: JSON.stringify(obj.polling_config.config)}).then(r=>r.json()));
        if (obj.time_window) {
          const twStartRaw = obj.time_window.webhooks_time_start ?? '';
          const twEndRaw = obj.time_window.webhooks_time_end ?? '';
          const isValidTime = (v) => typeof v === 'string' && (/^\d{1,2}:\d{2}$/.test(v) || /^\d{1,2}h\d{0,2}$/i.test(v));
          const start = isValidTime(twStartRaw) ? twStartRaw : '';
          const end = isValidTime(twEndRaw) ? twEndRaw : '';
          // Backend requires both or both empty (to clear). Avoid 400 by clearing if incomplete/invalid.
          const payload = (start && end) ? { start, end } : { start: '', end: '' };
          calls.push(fetch(api('/api/test/set_webhook_time_window'), { method:'POST', headers: headers(), body: JSON.stringify(payload)}).then(r=>r.json()));
        }
        if (obj.processing_prefs?.prefs) calls.push(fetch(api('/api/test/update_processing_prefs'), { method:'POST', headers: headers(), body: JSON.stringify(obj.processing_prefs.prefs)}).then(r=>r.json()));
        const results = await Promise.all(calls);
        setOut('outConfig', { success: true, results });
      } catch (e) { setOut('outConfig', { error: String(e) }); }
    };

    // --- Metrics from logs ---
    $('btnMetrics').onclick = async () => {
      try {
        const r = await fetch(api('/api/test/webhook_logs?days=1'), { headers: headers() });
        const d = await r.json();
        const logs = Array.isArray(d.logs) ? d.logs : [];
        const total = logs.length;
        const sent = logs.filter(l => l.status === 'success').length;
        const errors = logs.filter(l => l.status === 'error').length;
        const successRate = total ? Math.round((sent/total)*100) : 0;
        setOut('outMetrics', { total, sent, errors, successRate });
      } catch (e) { setOut('outMetrics', { error: String(e) }); }
    };

    // --- URL validator & preview ---
    $('btnValidate').onclick = () => {
      const v = $('inWebhookUrl').value.trim();
      const ok = isValidMakeWebhookUrl(v) || isValidHttpsUrl(v);
      $('lblValidate').textContent = ok ? 'valide' : 'invalide';
      $('lblValidate').className = 'small ' + (ok ? 'ok' : 'err');
    };

    $('btnPreview').onclick = () => {
      const payload = {
        subject: $('inSubject').value.trim(),
        sender_email: $('inSender').value.trim(),
        body_excerpt: $('inBody').value.trim().slice(0, 500),
        delivery_links: [],
        first_direct_download_url: null,
        meta: { preview: true, generated_at: new Date().toISOString() }
      };
      setOut('outPreview', payload);
    };

    function isValidHttpsUrl(url) {
      try { const u = new URL(url); return u.protocol === 'https:' && !!u.hostname; } catch { return false; }
    }
    function isValidMakeWebhookUrl(value) {
      if (isValidHttpsUrl(value)) return /hook\.eu\d+\.make\.com/i.test(value);
      return /^[A-Za-z0-9_-]{10,}@[Hh]ook\.eu\d+\.make\.com$/.test(value);
    }
  </script>
</body>
</html>
